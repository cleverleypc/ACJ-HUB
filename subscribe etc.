<?php
//
//实现关注、文本以及单图文的推送
//
//

define("TOKEN","WEIXIN");

$wechatObj = new wechatCallbackapiTest();
if (!isset($_GET['echostr'])){
	$wechatObj->responseMsg();
}else{
	$wechatObj->valid();
}

class wechatCallbackapiTest
{

	public function valid()
	{
		$echoStr = $_GET["echostr"];
		if($this->checkSignature()){
			echo $echoStr;
			exit;
		}
	}
	
	private function checkSignature()
	{
		$signature = $_GET["signature"];
		$timestamp = $_GET["timestamp"];
		$nonce = $_GET["nonce"];
		$token = TOKEN;
		$tmpArr = array($token, $timestamp, $nonce);
		sort($tmpArr);
		$tmpStr = implode($tmpArr);
		$tmpStr = sha1($tmpStr);
		
		if($tmpStr == $signature){
			return true;
		}else{
			return false;
		}
	}
	
	public function responseMsg()
	{
		$postStr = $GLOBALS["HTTP_RAW_POST_DATA"];
		if(!empty($postStr)){
			$postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);
			$RX_TYPE = trim($postObj->MsgType);
			
			switch ($RX_TYPE)
			{
				case "event":
					$result = $this->receiveEvent($postObj);
					break;
				case "text":
					$result = $this->receiveText($postObj);
					break;
				case "image":
					$result = $this->receiveImage($postObj);
					break;
				default:
					$result = "unknown msg type: ".RX_TYPE;
					break;
			}
			echo $result;
		}else {
			echo "";
			exit;
		}
	}
	
	private function receiveEvent($object)
	{
		$content = "";
		switch ($object->Event)
		{
			case "subscribe":
				$content = "welcome to my hub~~回复 小谢 or 小宝 获取更多...";
				break;
			case "unsubcribe":
				$content = "";
				break;
		}
		$result = $this->transmitText($object,$content);
		return $result;
	}
	
	private function receiveText($object)
	{
		$keyword = trim($object->Content);
		
		if($keyword == "小谢"){
			$content = "这仅仅是个调试";
			$result = $this->transmitText($object, $content);
		}
		else if ($keyword == "小宝"){
			$content = array();
			$content[] = array("Title"=>"我们家小谢呢~",
								"Description"=>"互相好不好？",
								"PicUrl"=>"http://1.cleverleypc.sinaapp.com/src/IMG_0079.JPG",
								"Url"=>"http://1.cleverleypc.sinaapp.com");
			$result = $this->transmitNews($object, $content);
		}
		return $result;
	}
	
	private function receiveImage($object)
	{
		$content = array("MediaId"=>$object->MediaId);
		$result = $this->transmitImage($object, $content);
		return $result;
	}
	
	private function transmitNews($object, $arr_item)
	{
		if(!is_array($arr_item))
			return;
			
		$itemTpl = "   <item>
		<Title><![CDATA[%s]]></Title>
		<Description><![CDATA[%s]]></Description>
		<PicUrl><![CDATA[%s]]></PicUrl>
		<Url><![CDATA[%s]]></Url>
		</item>
		";
		$item_str= "";
		foreach ($arr_item as $item)         //遍历数组中的元素
			$item_str .= sprintf($itemTpl, $item['Title'], $item['Description'], $item['PicUrl'], $item['Url']);
			
			$newsTpl = "<xml>
			<ToUserName><![CDATA[%s]]></ToUserName>
			<FromUserName><![CDATA[%s]]></FromUserName>
			<CreateTime>%s</CreateTime>
			<MsgType><![CDATA[news]]></MsgType>
			<Content><![CDATA[]]></Content>
			<ArticleCount>%s</ArticleCount>
			<Articles>
			$item_str</Articles>
			</xml>";
			
			$result  = sprintf($newsTpl, $object->FromUserName, $object->ToUserName, time(), count($arr_item));
			return $result;
	}
	
	private function transmitImage($object, $imageArray)
	{
		$itemTpl = "<Image>
		<MediaId><![CDATA[%s]]></MediaId>
		</Image>";
		
		$item_str = sprintf($itemTpl, $imageArray['MediaId']);
		
		$textTpl = "<xml>
		<ToUserName><![CDATA[%s]]></ToUserName>
		<FromUserName><![CDATA[%s]]></FromUserName>
		<CreateTime>%s</CreateTime>
		<MsgType><![CDATA[image]]></MsgType>
		$item_str
		</xml>";
		
		$result = sprintf($textTpl, $object->FromUserName, $object->ToUserName, time());
		return $result;
	}
	
	private function transmitText($object, $content)
	{
		$textTpl = "<xml>
					<ToUserName><![CDATA[%s]]></ToUserName>
					<FromUserName><![CDATA[%s]]></FromUserName>
					<CreateTime>%s</CreateTime>
					<MsgType><![CDATA[text]]></MsgType>
					<Content><![CDATA[%s]]></Content>
					</xml>";
		$result = sprintf($textTpl, $object->FromUserName, $object->ToUserName, time(), $content);
			return $result;
	}
}
					
?>
